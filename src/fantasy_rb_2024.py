# -*- coding: utf-8 -*-
"""Fantasy RB 2024.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1OxEysVZEfTstdR5QdnOi4P3xO0QfWoKK
"""

def clean_player_stats(df):
  df = df.drop(['DKPt',
 'FDPt',
 'PosRank',
 'OvRank',
 '-9999', 'FantPt', '2PM', '2PP', 'TD.3'], axis=1)

  df = df.rename(columns={"TD": "TD_passing", "Yds": "Yds_passing", "Att": "Att_passing", "Att.1": "Att_rushing", "Yds.1": "Yds_rushing", "TD.1": "TD_rushing"})

# Only RB's
  player_stats = df.loc[df['FantPos'] == 'RB']
  player_stats['Player'] = player_stats['Player'].str.replace(r'\*.*', '', regex=True)
  player_stats = player_stats.fillna(0)
  # player_stats = player_stats.add_suffix(f"_{year}", axis=1)
  # player_stats = player_stats.rename(columns={f"Player_{year}": "Player"})
  return player_stats

def clean_team_stats(df):
  team_name_conversion = pd.read_csv('team_name_conversion.csv')
  df = pd.merge(df, team_name_conversion, how='inner', left_on='Tm', right_on = 'Name')
# 'Cmp', 'Att', 'Yds.1', '1stD.1', 'TD', 'Int', 'NY/A',
  df.drop(['Tm', 'Name', 'Conference', 'Division', 'G',  'ID'], axis=1, inplace=True)
  df.rename(columns={'Att.1': 'rushing_attempts',
                                'Yds.2': 'rushing_yards',  'TD.1': 'rushing_td',  '1stD.2': 'rushing_1stdown',
                                'Yds.3': 'penalty_yards',  'Y/P': 'yards_per_play',
                                'Y/A': 'yards_per_rushing_attempt',  'Sc%': 'drives_score_pct',  'TO%': 'drives_to_pct'}, inplace=True)
  # df = df.add_suffix(f"_team_{year}", axis=1)
  return df




def clean_college_stats(df):
  df.drop(['-9999', 'School', 'Yds', 'Avg', 'TD', 'Yds.1', 'TD.1', 'Avg.1', 'Rk', 'Conf'], axis=1, inplace=True)
  # df.loc[df['Conf'].isin(['SEC', 'Big 12', 'ACC', 'Big Ten', 'Pac-12']), 'power5'] = 1
  # df['power5'].fillna(0, inplace=True)
  df.rename(columns={'Yds.2': 'Yds', 'Avg.2': 'Avg', 'TD.2': 'TD'}, inplace=True)
  df['Player'] = df['Player'].str.replace(r'\*.*', '', regex=True)
  df  = df.add_suffix(f'_college', axis=1)
  df.rename(columns={f'Player_college': 'Player'}, inplace=True)
  return df

def join_ppr_next_season(df, ppr_df):
  df.drop('PPR', axis=1, inplace=True)
  df = pd.merge(df, ppr_df, how='left', on='Player')
  return df

import pandas as pd
fantasy_stats_2023 = pd.read_csv('Fantasy_player_stats_2023.csv')
fantasy_stats_2022 = pd.read_csv('Fantasy_player_stats_2022.csv')
fantasy_stats_2021 = pd.read_csv('Fantasy_player_stats_2021.csv')
fantasy_stats_2020 = pd.read_csv('Fantasy_player_stats_2020.csv')
fantasy_stats_2019 = pd.read_csv('Fantasy_player_stats_2019.csv')


player_stats_2023 = clean_player_stats(fantasy_stats_2023)
player_stats_2022 = clean_player_stats(fantasy_stats_2022)
player_stats_2021 = clean_player_stats(fantasy_stats_2021)
player_stats_2020 = clean_player_stats(fantasy_stats_2020)
player_stats_2019 = clean_player_stats(fantasy_stats_2019)

ppr_2020 = player_stats_2020[['Player', 'PPR']]
ppr_2021 = player_stats_2021[['Player', 'PPR']]
ppr_2022 = player_stats_2022[['Player', 'PPR']]
ppr_2023 = player_stats_2023[['Player', 'PPR']]

player_stats_2019 = join_ppr_next_season(player_stats_2019, ppr_2020)
player_stats_2020 = join_ppr_next_season(player_stats_2020, ppr_2021)
player_stats_2021 = join_ppr_next_season(player_stats_2021, ppr_2022)
player_stats_2022 = join_ppr_next_season(player_stats_2022, ppr_2023)

offense_2023 = pd.read_csv('team_offense_2023.csv')
offense_2022 = pd.read_csv('team_offense_2022.csv')
offense_2021 = pd.read_csv('team_offense_2021.csv')
offense_2020 = pd.read_csv('team_offense_2020.csv')
offense_2019 = pd.read_csv('team_offense_2019.csv')


offense_2023_clean = clean_team_stats(offense_2023)
offense_2022_clean = clean_team_stats(offense_2022)
offense_2021_clean = clean_team_stats(offense_2021)
offense_2020_clean = clean_team_stats(offense_2020)
offense_2019_clean = clean_team_stats(offense_2019)

college_stats_2022 = pd.read_csv('college_rushing_2022.csv')
college_stats_2021 = pd.read_csv('college_rushing_2021.csv')
college_stats_2020 = pd.read_csv('college_rushing_2020.csv')
college_stats_2019 = pd.read_csv('college_rushing_2019.csv')
college_stats_2018 = pd.read_csv('college_rushing_2018.csv')

player_college_stats_2022 = clean_college_stats(college_stats_2022)
player_college_stats_2021 = clean_college_stats(college_stats_2021)
player_college_stats_2020 = clean_college_stats(college_stats_2020)
player_college_stats_2019 = clean_college_stats(college_stats_2019)
player_college_stats_2018 = clean_college_stats(college_stats_2018)

player_team_stats_2023 = pd.merge(player_stats_2023, offense_2023_clean, how='left', left_on='Tm', right_on='Abbreviation')
player_team_stats_2022 = pd.merge(player_stats_2022, offense_2022_clean, how='left', left_on='Tm', right_on='Abbreviation')
player_team_stats_2021 = pd.merge(player_stats_2021, offense_2021_clean, how='left', left_on='Tm', right_on='Abbreviation')
player_team_stats_2020 = pd.merge(player_stats_2020, offense_2020_clean, how='left', left_on='Tm', right_on='Abbreviation')
player_team_stats_2019 = pd.merge(player_stats_2019, offense_2019_clean, how='left', left_on='Tm', right_on='Abbreviation')

total_player_stats_2023 = pd.merge(player_team_stats_2023, player_college_stats_2022, how='left', on='Player')
total_player_stats_2022 = pd.merge(player_team_stats_2022, player_college_stats_2021, how='left', on='Player')
total_player_stats_2021 = pd.merge(player_team_stats_2021, player_college_stats_2020, how='left', on='Player')
total_player_stats_2020 = pd.merge(player_team_stats_2020, player_college_stats_2019, how='left', on='Player')
total_player_stats_2019 = pd.merge(player_team_stats_2019, player_college_stats_2018, how='left', on='Player')

total_player_stats_2022_copy1 = total_player_stats_2022.copy()
total_player_stats_2022_copy2 = total_player_stats_2022.copy()
total_player_stats_2022_copy3 = total_player_stats_2022.copy()
total_player_stats_2022_copy4 = total_player_stats_2022.copy()

total_player_stats_2021_copy1 = total_player_stats_2021.copy()
total_player_stats_2021_copy2 = total_player_stats_2021.copy()
total_player_stats_2021_copy3 = total_player_stats_2021.copy()

total_player_stats_2020_copy1 = total_player_stats_2020.copy()
total_player_stats_2020_copy2 = total_player_stats_2020.copy()

total_player_stats_2019_copy1 = total_player_stats_2019.copy()

total_player_stats_2022 = pd.concat([total_player_stats_2022, total_player_stats_2022_copy1])
total_player_stats_2022 = pd.concat([total_player_stats_2022, total_player_stats_2022_copy2])
total_player_stats_2022 = pd.concat([total_player_stats_2022, total_player_stats_2022_copy3])
total_player_stats_2022 = pd.concat([total_player_stats_2022, total_player_stats_2022_copy4])

total_player_stats_2021 = pd.concat([total_player_stats_2021, total_player_stats_2021_copy1])
total_player_stats_2021 = pd.concat([total_player_stats_2021, total_player_stats_2021_copy2])
total_player_stats_2021 = pd.concat([total_player_stats_2021, total_player_stats_2021_copy3])

total_player_stats_2020 = pd.concat([total_player_stats_2020, total_player_stats_2020_copy1])
total_player_stats_2020 = pd.concat([total_player_stats_2020, total_player_stats_2020_copy2])

total_player_stats_2019 = pd.concat([total_player_stats_2019, total_player_stats_2019_copy1])

total_stats = pd.concat([total_player_stats_2022, total_player_stats_2021])
total_stats = pd.concat([total_stats, total_player_stats_2020])
total_stats = pd.concat([total_stats, total_player_stats_2019])

def final_cleaning(df):
  df['PPR'].fillna(0, inplace=True)
  df['G_college'].fillna(-1, inplace=True)
  df['Rec_college'].fillna(-1, inplace=True)
  df['Plays_college'].fillna(-1, inplace=True)
  df['Yds_college'].fillna(-1, inplace=True)
  df['Avg_college'].fillna(-1, inplace=True)
  df['TD_college'].fillna(-1, inplace=True)
  df['PF'].fillna(-1, inplace=True)
  df['Yds'].fillna(-1, inplace=True)
  df['Ply'].fillna(-1, inplace=True)
  df['TO'].fillna(-1, inplace=True)
  df['FL_y'].fillna(-1, inplace=True)
  df['rushing_attempts'].fillna(-1, inplace=True)
  df['rushing_yards'].fillna(-1, inplace=True)
  df['rushing_td'].fillna(-1, inplace=True)
  df['yards_per_rushing_attempt'].fillna(-1, inplace=True)
  df['rushing_1stdown'].fillna(-1, inplace=True)
  df['Pen'].fillna(-1, inplace=True)
  df['penalty_yards'].fillna(-1, inplace=True)
  df['1stPy'].fillna(-1, inplace=True)
  df['drives_score_pct'].fillna(-1, inplace=True)
  df['drives_to_pct'].fillna(-1, inplace=True)
  df['EXP'].fillna(-1, inplace=True)
  df['yards_per_play'].fillna(-1, inplace=True)
  df['1stD'].fillna(-1, inplace=True)

  df.drop(['Rk_x', 'Rk_y', 'Tm', 'FantPos', 'Abbreviation'], axis=1, inplace=True)
  return df

total_stats = final_cleaning(total_stats)
prediction_data_2024 = final_cleaning(total_player_stats_2023)

import lightgbm as lgb
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler

features = total_stats.drop('PPR', axis=1)

# Define the target variable as 'charges'
target = total_stats['PPR']

# Split the data into training and validation sets
X_train, X_val, Y_train, Y_val = train_test_split(features, target,
                                                  # random_state=2023,
                                                  test_size=0.2)

# Display the shapes of the training and validation sets
X_train.shape, X_val.shape

validation_players = X_val['Player']
X_val.drop(['Player'], axis=1, inplace=True)
X_train.drop(['Player'], axis=1, inplace=True)

# Standardize Features

# Use StandardScaler to scale the training and validation data
scaler = StandardScaler()
#Fit the StandardScaler to the training data
scaler.fit(X_train)
# transform both the training and validation data
X_train_scaled = scaler.transform(X_train)
X_val_scaled = scaler.transform(X_val)

# Import necessary libraries for calculating mean squared error and using the LightGBM regressor.
from sklearn.metrics import mean_squared_error as mse
from lightgbm import LGBMRegressor

# Create an instance of the LightGBM Regressor with the RMSE metric.
model = LGBMRegressor(metric='rmse')

# Train the model using the training data.
model.fit(X_train_scaled, Y_train)

# Make predictions on the training and validation data.
X_train['preds'] = model.predict(X_train_scaled)
X_val['preds'] = model.predict(X_val_scaled)

X_train['actual'] = Y_train
X_val['actual'] = Y_val

# Calculate and print the Root Mean Squared Error (RMSE) for training and validation predictions.
from sklearn.metrics import mean_squared_error as mse
import numpy as np
print("Training RMSE: ", np.sqrt(mse(X_train['actual'], X_train['preds'])))
print("Validation RMSE: ", np.sqrt(mse(X_val['actual'], X_val['preds'])))

X_val_reset = X_val.reset_index()
val_players_reset = validation_players.reset_index()

final_valid = pd.merge(X_val_reset, val_players_reset, left_index=True, right_index=True)

final_valid[['Player', 'preds', 'actual']].sort_values(by='preds', ascending=False)

validation_players_2024 = prediction_data_2024['Player']
prediction_data_2024.drop(['Player', 'PPR'], axis=1, inplace=True)
scaled_2024_preds = scaler.transform(prediction_data_2024)

prediction_data_2024['preds'] = model.predict(scaled_2024_preds)

predicted_stats_2024 = pd.merge(prediction_data_2024, validation_players_2024, left_index=True, right_index=True)

model_preds = predicted_stats_2024[['Player', 'preds']]

model_preds.sort_values('preds', ascending=False)

